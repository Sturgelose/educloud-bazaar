<script src="{{ STATIC_URL }}shop/js/bower_components/jquery-ui/ui/minified/jquery-ui.min.js"></script>
<script src="{{ STATIC_URL }}shop/js/bower_components/jquery.oembed/index.js"></script>

<script type="text/javascript">

    // Animations
    //$('#content').addClass('animated fadeInDown');

    var accordionSwitchHeight = $('#accordion-switch').css('height');
    $(document).ready(function(){
        $('img.svg').each(function(){
            var $img = $(this);
            var imgID = $img.attr('id');
            var imgClass = $img.attr('class');
            var imgURL = $img.attr('src');

            $.get(imgURL, function(data) {
                // Get the SVG tag, ignore the rest
                var $svg = $(data).find('svg');

                // Add replaced image's ID to the new SVG
                if(typeof imgID !== 'undefined') {
                    $svg = $svg.attr('id', imgID);
                }
                // Add replaced image's classes to the new SVG
                if(typeof imgClass !== 'undefined') {
                    $svg = $svg.attr('class', imgClass+' replaced-svg');
                    if( imgClass.indexOf('menu-icon') > -1) {
                        $svg = $svg.click(toggleMenuItem);
                    }
                }


                // Remove any invalid XML tags as per http://validator.w3.org
                $svg = $svg.removeAttr('xmlns:a');

                // Replace image with new SVG
                $img.replaceWith($svg);

            }, 'xml');

        });

        
        $('#language-icon .menu-icon').click(function() {
            if($(this).parent().find('.menu-box').is(":visible")) {
                $('.menu-box').hide('fade');
                $('#language-icon i').removeClass('fa-caret-up').addClass('fa-caret-down');
                $('#icons > .flexItem').removeClass('active');
            } else {
                $('.menu-box').hide('fade');
                $('#language-icon i').removeClass('fa-caret-down').addClass('fa-caret-up');
                $('#icons > .flexItem').removeClass('active');
                $(this).parent().addClass('active');
                $(this).parent().find('.menu-box').show('fade');
            }
        });

        preparePage();

        // Oembed implementation
        $("a.embed").oembed(null, {
           embedMethod: 'fill'
        });
    });

    function toggleMenuItem() {
        if($(this).parent().find('.menu-box').is(":visible")) {
            $('.menu-box').hide('fade');
            $('#icons > .flexItem').removeClass('active');
        } else {
            $('.menu-box').hide('fade');
            $('#icons > .flexItem').removeClass('active');
            $(this).parent().addClass('active');
            $(this).parent().find('.menu-box').slideDown();
        }
    }

    function preparePage(){

        //$('#tabs-product').tabs({show: 'fade'});

        $('.menu-head-icon').hover(
            function(){
                $(this).css('background-image',"url('{{ STATIC_URL }}shop/img/logo_blue.png')");
            },
            function(){
                $(this).css('background-image',"url('{{ STATIC_URL }}shop/img/logo_grey.png')");

        });

        $('#generalSearch input').focus(function(){
            $('.menu-box').hide('fade');
            $('#icons > .flexItem').removeClass('active');
        });

        $('#menu-categories').on('click', function(){
            $('.menu-box').hide('fade');
            $('#icons > .flexItem').removeClass('active');
            if($('#categories-bar').is(":visible")) {
                $('#menu-categories i').removeClass('fa-caret-up').addClass('fa-caret-down');
                $(this).removeClass('active');
                $('.barshadow').slideDown();
                $('#categories-bar').slideUp(300, function() {
                    $('#navbar').css('position','fixed');
                });
            } else {
                $('#navbar').css('position','static');
                $('.barshadow').hide();
                $(this).addClass('active');
                $('#menu-categories i').removeClass('fa-caret-down').addClass('fa-caret-up');
                $('#categories-bar').slideDown();
            }
        });
        $('#categories-bar li').on('click', function() {
            
            if($(this).hasClass('all-option')){
                if($(this).hasClass('selected')){
                    //Do nothing. Keep all selected
                } else {
                    $(this).parents('.options').find('li').removeClass('selected');
                    $(this).addClass('selected');
                }
            } else {
                $(this).parents('.options').find('li.all-option').removeClass('selected');
                areAllSelected = $(this).parents('.options').find('li:not(.all-option):not(.selected)').length < 2;
                
                if (areAllSelected){
                    if($(this).hasClass('selected')){
                        $(this).toggleClass('selected');
                    } else {
                        $(this).parents('.options').find('li').removeClass('selected');
                        $(this).parents('.options').find('li.all-option').addClass('selected');
                    }
                } else {
                    $(this).toggleClass('selected');
                }

            }
        });

        $( "#price-slider" ).slider({
          range: true,
          min: 0,
          max: 500,
          values: [ 0, 500 ],
          slide: function( event, ui ) {
            $( "#price-range" ).val( "€" + ui.values[ 0 ] + " - €" + ui.values[ 1 ] );
          }
        });
        $( "#price-range" ).val( "€" + $( "#price-slider" ).slider( "values", 0 ) +
            " - €" + $( "#price-slider" ).slider( "values", 1 ) );


        $('.py-messages .close-btn').click(function(){
            $(this).parent().hide('fade');
        })

    }

    // This function retrieves the selected filters and generate a JSON object with
    // the search parameters to send to the backend for processing
    function requestSearch(){

        var request = {};

        request['searchString'] = $('#generalSearch input').val();
        request['selectedSubjects'] = $('#options-subject').find('li.selected:not(.all-option)').map(function(){return $(this).text();}).get();
        request['selectedGrade'] = $('#options-grade').find('li.selected:not(.all-option)').map(function(){return $(this).text();}).get();
        request['selectedType'] = $('#options-type').find('li.selected:not(.all-option)').map(function(){return $(this).text();}).get();
        request['selectedPublisher'] = $('#options-publisher').find('li.selected:not(.all-option)').map(function(){return $(this).text();}).get();
        request['selectedPrice'] = {min : $( "#price-slider" ).slider( "values", 0 ), max : $( "#price-slider" ).slider( "values", 1 )};

        console.log(JSON.stringify(request));
        //TODO send to backend, retrieve results and show them.
    }

</script>
